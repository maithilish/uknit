# Release

## Assembly

Run `mvn clean package` to create the release zip. The release zip `uknit-1.0-release.zip` is created in `core/target` dir.

The contents of zip are

	quickstart/pom.xml
	quickstart/src/main/java/org/codetab/uknit/quickstart/Quickstart.java
	uknit/pom.xml
	uknit/modules/uknit-release-1.0.jar
	uknit/resources/uknit.properties
	uknit/resources/uknit-names.properties
	uknit/resources/log4j2.xml

It contains two maven projects - uknit and quickstart. The `uknit/modules/uknit-release-1.0.jar` is the uber jar created by shade plugin with all dependencies.

## Assembly

### Assembly folders

The `assembly/uknit` and `assembly/quickstart` folders contains basic pom.xml for uknit-release and quickstart. These folders are copied as it is to release zip by assembly. The `uknit.properites` of core is used for development so it is not copied to zip, instead a custom file `assembly/uknit/resources/uknit.properties` that is specific to quickstart is copied to zip. The `uknit-names.properties` and `log4j2.xml` are part of core and copied from `core/src/main/resources` to zip. The uknit-release-1.0.jar is the shade jar copied from `core/target`.

### Why Shade Jar

The jar plugin produces jar for just uknit project and assembly plugin copies this jar and each and every depend jar to modules folder in release zip. Whereas the shade jar make a flat jar with all classes from uknit and its depends and assembly copy shade single jar to modules folder.

In IntelliJ the jars can be added in two ways either in Module Settings or in run config classpath. The Module settings allows to add modules folder or shade jar but is removed every time Maven projects are rebuild in Maven Tool Window: it is not useful. If you add module folder to classpath then class not found error is thrown on run. To work we have to add each and every jar of uknit and its depends. If we add shade jar to run classpath then it works as expected. The resources folder added to run classpath works as expected and uknit.properties is loaded without problem.

## Release

### gpg and keyserver

refer: https://central.sonatype.org/pages/working-with-pgp-signatures.html

	gpg --full-gen-key						# generate key		
	gpg --list-key		
	gpg --armor --export <key id>			# view public key
	
	# publish pub key and search key
	gpg --keyserver keyserver.ubuntu.com --send-keys <key id>
	gpg --keyserver hkp://keyserver.ubuntu.com --search-key 'maithilish@gmail.com'

	# export and backup
	gpg --output backupkeys.pgp --armor --export-secret-keys --export-options export-backup maithilish@gmail.com
	gpg --import-options restore --import /orange/data/export/gpg/backupkeys.pgp

### Deploy Artifacts to Maven Central

The uknit and uknit-core artifacts are deployed to Sonatype OSSRH server.

refer - https://central.sonatype.org/publish/publish-guide/
		https://www.cesarsotovalero.net/blog/deploying-to-maven-central.html
	    https://maciejwalkowiak.com/blog/guide-java-publish-to-maven-central/

Nexus Repository Manager: https://s01.oss.sonatype.org/.
Click on Views/Repositories - Repository to browse staging and release repositories. 

Sonatype JIRA: https://issues.sonatype.org/login.jsp

Latest central: https://central.sonatype.com/
Old central: https://mvnrepository.com/repos/central

Sonatype OSSRH (OSS Repository Hosting) uses Sonatype Nexus Repository Manager to access the repository. The deploy plugin uploads/deploy the files to ossrh and the nexus-staging-maven-plugin stages and releases it. We can indicate which module to release by adding plugin to build in respective pom.xml. The plugin is added to uknit/pom.xml and uknit-core/pom.xml but not for uknit-itest/pom.xml. With this config, the deploy plugin uploads itest artifacts but staging/release doesn't happen. The md5 and ssh1 checksum are generated by during deploy by deploy plugin.

However, without nexus-staging plugin in itest/pom.xml you will get "missing nexusUrl" error if you run goals of nexus-staging such as `mvn nexus-staging:release`, `mvn nexus-staging:drop` or `mvn nexus-staging:rc-list` etc., To fix this, we have to temporarily add nexus-staging plugin snippet to itest/pom.xml, run these commands and later remove the plugin from itest/pom.xml.

Delete failed from staging (add staging plugin to itest else missing nexusUrl error)

	mvn nexus-staging:rc-list
	mvn nexus-staging:rc-drop -DstagingRepositoryId=orgcodetabuknit-1025

We can also use the above technique to upload single module. For example, we initially uploaded uknit-core-1.0.0-M1 but not the parent uknit-1.0.0-M1. Because of missing parent release was broken. Again uploaded both artifacts fails as OSSRH doesn't allow overwrite of artifacts. To upload the parent, we kept nexus-staging in uknit, removed from uknit-core and uploaded only uknit-1.0.0-M1.
